---
title: node.js 同步获取网络数据
date: 2018-05-03 11:49:35
categories: node.js
tags:
  - node.js
  - 同步
  - 异步
---
#### 背景
项目要上devops，配置中心是整个平台重要的一环，通过它可以自由的配置项目需要的一些配置项。
传统服务器部署的方式，通过系统环境变量指定系统的配置项，在程序中通过环境变量指定的地址进行读取。修改配置项，需要远程登录主机，通过vim编辑器修改。
现在的改进方案是，将通过etcd作为配置中心，在容器启动时配置环境变量配置etcd对应项目的key的接口，在程序中通过调用接口获取配置信息，将配置中心作为独立的一块进行管理，方便了部署。
针对该方案，需要对项目的代码进行修改，将原有的通过环境变量加载配置文件的方式修改为，从配置中心拉取数据的方式。
修改方案很简单，将原有的读取文件修改为读取网络文件（linux理念一切皆文件）。

#### 问题点
确定了修改了方案，那么接下来就是行动了，项目使用的是node.js，都知道node.js最大的编程特点，处理I/O操作时，通过异步回调无阻塞的方式进行的。作为一个全局使用的配置文件项，这里不能使用异步的方式进行处理，为什么？
后续的业务处理需要依赖读取的配置项，也就是这里需要阻塞，否则，后续业务获取的配置项都为undefined。node.js 在处理这种I／O操作都是异步非阻塞的，现在，怎么让的同步阻塞呢？

#### 处理的办法
真对以上的node.js同步编程进行搜索，得到的结果大都是promise,async的结果，将异步转化为同步的处理的处理方式，但这种方式只是书面，只是为了方便我们进行程序开发，符合我们处理事情的习惯，但程序后台执行的顺序依旧是异步的方式，也就是说程序执行是没有阻塞的，这种处理方式肯定不能满足我们的解决以上问题的需要？
最后通过锲而不舍的搜索，找到了这样的一个库[sync-request](https://www.npmjs.com/package/sync-request)可以解决该问题，它阻塞的javascript的引擎的执行，正是我们需要的。
通过它获取etcd接口配置，拉取文件内容

#### 基本用法
```
// 用法1
var request = require('sync-request');
var res = request('GET', 'https://example.com', {
  headers: {
    'user-agent': 'example-user-agent',
  },
});
console.log(res.getBody());
```